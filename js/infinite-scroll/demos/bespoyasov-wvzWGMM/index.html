<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CodePen - doka-infinite-scroll</title>
  <style>
    body,
    html {
      margin: 0;
      font-family: sans-serif;
      font-size: 15px;
      line-height: 1.5;
    }

    .header,
    .footer {
      text-align: center;
    }

    .footer {
      padding-bottom: 1em;
    }

    main {
      max-width: 640px;
      margin: auto auto 2em;
    }

    .post {
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
      border-radius: 5px;
      padding: 0.2em 1em 0.5em;
    }

    .post + .post {
      margin-top: 2em
    }

    .post footer {
      border-top: 1px solid rgba(0,0,0,.1);
      font-size: 20px;
    }

    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Switter</h1>
  </header>

  <main>
    <article class="post">
      <h1>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞</h1>
      <p>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –≤ –ª—É—á—à–µ–π –Ω–∞ —Å–≤–µ—Ç–µ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ Switter. –í—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—ã–º—ã—à–ª–µ–Ω—ã –∏ —Å–ª—É—á–∞–π–Ω—ã.</p>
      <footer>
        <button type="button">‚ù§Ô∏è 20</button>
        <button type="button">üîÑ 20</button>
      </footer>
    </article>

    <article class="post">
      <h1>–î—Ä—É–≥–æ–π –ø–æ—Å—Ç</h1>
      <p>–í–¥–∞–ª–∏ –æ—Ç –≤—Å–µ—Ö –∂–∏–≤—É—Ç –æ–Ω–∏ –≤ –±—É–∫–≤–µ–Ω–Ω—ã—Ö –¥–æ–º–∞—Ö –Ω–∞ –±–µ—Ä–µ–≥—É –°–µ–º–∞–Ω—Ç–∏–∫–∞ –±–æ–ª—å—à–æ–≥–æ —è–∑—ã–∫–æ–≤–æ–≥–æ –æ–∫–µ–∞–Ω–∞. –ú–∞–ª–µ–Ω—å–∫–∏–π —Ä—É—á–µ—ë–∫ –î–∞–ª—å –∂—É—Ä—á–∏—Ç –ø–æ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–µ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ—ë –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏. </p>
      <footer>
        <button type="button">‚ù§Ô∏è 42</button>
        <button type="button">üîÑ 69</button>
      </footer>
    </article>

    <article class="post">
      <h1>–ü—Ä–æ—Å–Ω—É–≤—à–∏—Å—å –æ–¥–Ω–∞–∂–¥—ã —É—Ç—Ä–æ–º –ø–æ—Å–ª–µ –±–µ—Å–ø–æ–∫–æ–π–Ω–æ–≥–æ —Å–Ω–∞...</h1>
      <p>...–ì—Ä–µ–≥–æ—Ä –ó–∞–º–∑–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –æ–Ω —É —Å–µ–±—è –≤ –ø–æ—Å—Ç–µ–ª–∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ —Å—Ç—Ä–∞—à–Ω–æ–µ –Ω–∞—Å–µ–∫–æ–º–æ–µ. –õ—ë–∂–∞ –Ω–∞ –ø–∞–Ω—Ü–∏—Ä–Ω–æ—Ç–≤–µ—Ä–¥–æ–π —Å–ø–∏–Ω–µ, –æ–Ω –≤–∏–¥–µ–ª, —Å—Ç–æ–∏–ª–æ –µ–º—É –ø—Ä–∏–ø–æ–¥–Ω—è—Ç—å –≥–æ–ª–æ–≤—É, —Å–≤–æ–π –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π, –≤—ã–ø—É–∫–ª—ã–π...</p>
      <footer>
        <button type="button">‚ù§Ô∏è 146</button>
        <button type="button">üîÑ 34</button>
      </footer>
    </article>

    <article class="post">
      <h1>–°—Ç—Ä–∞–¥–∞–Ω–∏—è —é–Ω–æ–≥–æ –í–µ—Ä—Ç–µ—Ä–∞</h1>
      <p>–î—É—à–∞ –º–æ—è –æ–∑–∞—Ä–µ–Ω–∞ –Ω–µ–∑–µ–º–Ω–æ–π —Ä–∞–¥–æ—Å—Ç—å—é, –∫–∞–∫ —ç—Ç–∏ —á—É–¥–µ—Å–Ω—ã–µ –≤–µ—Å–µ–Ω–Ω–∏–µ —É—Ç—Ä–∞, –∫–æ—Ç–æ—Ä—ã–º–∏ —è –Ω–∞—Å–ª–∞–∂–¥–∞—é—Å—å –æ—Ç –≤—Å–µ–≥–æ —Å–µ—Ä–¥—Ü–∞. –Ø —Å–æ–≤—Å–µ–º –æ–¥–∏–Ω –∏ –±–ª–∞–∂–µ–Ω—Å—Ç–≤—É—é –≤ –∑–¥–µ—à–Ω–µ–º –∫—Ä–∞—é, —Å–ª–æ–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –¥–ª—è —Ç–∞–∫–∏—Ö, –∫–∞–∫ —è.</p>
      <footer>
        <button type="button">‚ù§Ô∏è 4</button>
        <button type="button">üîÑ 20</button>
      </footer>
    </article>
  </main>

  <footer class="footer">
    &copy; Switter, 2020
  </footer>

  <template id="post_template">
    <article class="post">
      <h1></h1>
      <p></p>
      <footer>
        <button type="button">‚ù§Ô∏è </button>
        <button type="button">üîÑ </button>
      </footer>
    </article>
  </template>
  <script>
    // ¬´–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö¬ª:

    const post = {
      title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞',
      body: '–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –≤ –ª—É—á—à–µ–π –Ω–∞ —Å–≤–µ—Ç–µ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ Switter. –í—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—ã–º—ã—à–ª–µ–Ω—ã –∏ —Å–ª—É—á–∞–π–Ω—ã.',
      likes: 77,
      reposts: 7,
    }


    // ¬´–°–µ—Ä–≤–µ—Ä API¬ª:

    const server = {
      posts(page = 2) {
        const finished = page >= 5;
        const next = finished ? null : page + 1;
        const posts = Array(5).fill(post);

        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({posts, next});
          }, 0)
        })
      }
    };


    // –ö–ª–∏–µ–Ω—Ç:

    let nextPage = 2;
    let isLoading = false;
    let shouldLoad = true;

    function appendPost(postData) {
      if (!postData) return;
      const main = document.querySelector('main');
      const postNode = composePost(postData);
      main.append(postNode);
    }

    function composePost(postData) {
      if (!postData) return;
      const template = document.getElementById('post_template');
      const post = template.content.cloneNode(true);

      const {title, body, likes, reposts} = postData;
      post.querySelector('h1').innerText = title;
      post.querySelector('p').innerText = body;
      post.querySelector('button:first-child').innerText += likes;
      post.querySelector('button:last-child').innerText += reposts;

      return post;
    }

    async function fetchPosts() {
      if (isLoading || !shouldLoad) return;
      isLoading = true;

      const {posts, next} = await server.posts(nextPage);
      nextPage = next;

      posts.forEach(appendPost);

      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É,
      // —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏.

      if (!next) shouldLoad = false;
      isLoading = false;
    }

    function throttle(callee, timeout) {
      let timer = null;

      return function perform(...args) {
        if (timer) return;

        timer = setTimeout(() => {
          callee(...args);

          clearTimeout(timer);
          timer = null;
        }, timeout);
      }
    }

    async function checkPosition() {
      const height = document.body.offsetHeight;
      const screenHeight = window.innerHeight;
      const scrolled = window.scrollY;

      const threshold = height - screenHeight / 4;
      const position = scrolled + screenHeight;

      if (position >= threshold) {
        await fetchPosts();
      }
    }

    (() => {
      window.addEventListener('scroll', throttle(checkPosition));
      window.addEventListener('resize', throttle(checkPosition));
    })();
  </script>
</body>
</html>
