<!DOCTYPE html>
<html lang="ru">
<head>
  <title>DEMO — ARTICLE — Дока</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">
  <style>
    html {
      color-scheme: dark;
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      background-color: #18191C;
      color: #FFFFFF;
      font-family: "Roboto", sans-serif;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      position: relative;
      background-color: #18191C;
    }

    .main-container div {
      box-sizing: border-box;
    }

    .description {
      margin: 0 1rem;
      font-size: 1.5rem;
      color: #C56FFF;
    }

    .repo-name {
      margin: 0 1rem 0 .5rem;
      font-size: 1.5rem;
      color: #FFF;
    }

    .loading {
      font-size: 1.5rem;
      color: #C56FFF;
    }

    .year {
      display: flex;
      margin: 2rem 1rem 1rem 1rem;
    }

    .month-label {
      width: 0;
      margin-top: -1rem;
      overflow-x: visible;
      font-size: .75rem;
      color: #FFF;
    }

    .week {
      display: flex;
      flex-direction: column;
      flex: 0 0 auto;
    }

    .day {
      width: 10px;
      height: 10px;
      margin: 1px;
      border: 1px solid #88888818;
      border-radius: 2px;
    }
    .day:hover {
      border-color: #8885;
    }
    .day.has-commits:hover {
      border-color: #888a;
    }

    .cell {
      background-color: #28e628;
    }

    .tooltip {
      position: absolute;
      width: max-content;
      max-width: 400px;
      padding: 8px 16px;
      border-radius: 4px;
      background-color: #555;
      color: #FFF;
    }

    .hidden {
      visibility: hidden;
    }
  </style>
</head>
<body>
  <div id="repoGridContainer" class="main-container">
    <div class="description">
      <span class="loading">
        Загрузка...
      </span>
    </div>

    <div
      class="tooltip hidden"
      role="tooltip"
      id="tooltip"
      data-position="top"
    />
  </div>

  <script>
    const GITHUB_REPO_API = 'https://api.github.com/repos'
    const REPO = 'doka-guide/content'
    const REQ_MAX_ATTEMPTS = 3
    const REQ_ATTEMPT_TIMEOUT = 15000
    const ERR_202 = 'Данные не готовы'

    const DATE_FORMATTER = new Intl.DateTimeFormat('ru', {
      year: 'numeric',
      month: 'numeric',
      day: 'numeric',
    })
    const DATE_MONTH_FORMATTER = new Intl.DateTimeFormat('ru', {
      month: 'short',
    })

    const COLOR_MAX_STEPS = 10
    const COLOR_MIN_STEPS = 4
    const BASE_HSL = [112, 100, 80] // #a6ff99

    function requestGitHubData(url) {
      try {
        return fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'X-GitHub-Api-Version': '2022-11-28'
          }
        })
      } catch (error) {
        console.error(error)
        return []
      }
    }

    function createURL() {
      return `${GITHUB_REPO_API}/${REPO}/stats/commit_activity`
    }

    async function fetchCommitStat(requestParams = {}) {
      try {
        const {
          url = createURL(),
          requestAttempts = REQ_MAX_ATTEMPTS,
          requestAttemptTimeout = REQ_ATTEMPT_TIMEOUT
        } = requestParams

        const response = await requestGitHubData(url)

        if (response.status === 202) {
          if (requestAttempts > 0) {
            await new Promise(r => setTimeout(r, requestAttemptTimeout));

            return fetchCommitStat({
              url,
              requestAttempts: requestAttempts - 1
            })
          }

          throw new Error(ERR_202)
        }

        if (response.ok) {
          return await response.json()
        }
      } catch (error) {
        console.error(error)
        return Promise.reject(error)
      }
    }

    function getWeekDate(weekTimestamp) {
      return new Date(weekTimestamp * 1000)
    }

    function getDateFormat(date) {
      return DATE_FORMATTER.format(date)
    }

    function getMonthName(date) {
      return DATE_MONTH_FORMATTER.format(date)
    }

    function parseResponse(responseData = []) {
      if (!Array.isArray(responseData)) {
        return []
      }

      return responseData.map(item => {
        const { days, total, week } = item
        const weekStartDate = getWeekDate(week)
        const day = weekStartDate.getUTCDate()
        const isFirstWeekOfMonth = day < 8

        return {
          days: days.map((count, dayIndex) => {
            const newDate = weekStartDate.setUTCDate(day + dayIndex)
            const date = getDateFormat(newDate)
            console.log(':', day + dayIndex, newDate.toString(), date);
            return {
              count,
              date
            }
          }),
          month: isFirstWeekOfMonth
            ? getMonthName(weekStartDate)
            : ''
        }
      })
    }

    function analyzeCommitCounts(data) {
      const {min, max} = data.reduce((acc, weekData) => {
        const counts = weekData.days.map(item => item.count)
        acc.min = Math.min(...counts, acc.min)
        acc.max = Math.max(...counts, acc.max)
        return acc
      }, {min: Number.POSITIVE_INFINITY, max: 0})

      let steps = Math.max(Math.min(max, COLOR_MAX_STEPS), COLOR_MIN_STEPS)

      return { min, max, steps }
    }

    function generatePalette(hsl, steps) {
      const [h, s, lBase] = hsl
      const palette = []

      for (let i = 0; i < steps - 1; i++) {
        let lStep = lBase - (lBase * i) / steps
        lStep = Math.max(0, lStep)

        palette.push(`hsl(${h}, ${s}%, ${Math.round(lStep)}%)`)
      }

      palette.push(`hsl(0, 0%, 12%)`) //

      return palette.reverse()
    }

    function makeColors(countsInfo) {
      const {steps} = countsInfo

      return generatePalette(BASE_HSL, steps)
    }

    function showLoading(show, description) {
      const loadingElem = description.querySelector('.loading')
      loadingElem?.classList.toggle('hidden', !show)
    }

    function renderRepoInfo({repoName}, description) {
      description.innerHTML = `
        <span class='repo-label'>
          Репозиторий:
        </span>
        <span class="repo-name">
          ${repoName}
        </span>
      `
    }

    function showError(error, element) {
      const errorMessage = error?.message ?? `${error}`
      const message = `Ошибка получения данных: ${errorMessage}`
      element.innerText = message
    }

    function renderYearGrid(params, parentContainer) {
      const {data = [], countsInfo = {}, colors = []} = params
      const columns = data.length ?? 0
      if (columns === 0) return

      const {min, max, steps} = countsInfo
      const factor = steps - 1

      const yearContainer = document.createElement('div')
      yearContainer.className = 'year'

      data.forEach(weekData => {
        const {days, month} = weekData
        if (month) {
          const monthLabel = document.createElement('div')
          monthLabel.className = 'month-label'
          monthLabel.innerText = month
          yearContainer.appendChild(monthLabel)
        }
        const weekContainer = document.createElement('div')
        weekContainer.className = 'week'

        days.forEach(dayData => {
          const {count, date} = dayData
          let colorIndex = count > 0
            ? Math.min(
                Math.ceil((count / max) * steps) + (count > 1 ? 1 : 0),
                factor
              )
            : 0

          const dayContainer = document.createElement('div')
          let className = 'day cell'
          dayContainer.style.background = colors[colorIndex]
          dayContainer.setAttribute('data-date', date)
          if (count) {
            dayContainer.setAttribute('data-count', count)
            className += ' has-commits'
          }
          dayContainer.className = className
          weekContainer.appendChild(dayContainer)
        })

        yearContainer.appendChild(weekContainer)
      })

      parentContainer.appendChild(yearContainer)
      return yearContainer
    }

    function bindTooltip(yearGrid, parentContainer) {
      if (! yearGrid || ! parentContainer) return

      const tooltip = parentContainer.querySelector('.tooltip')

      if (! tooltip) return

      let top = 0
      let left = 0

      const toggleTooltip = (target = null) => {
        const show = target !== null

        if (show) {
          const {offsetTop, offsetLeft} = target
          const date = target.getAttribute('data-date')
          const count = target.getAttribute('data-count')

          tooltip.style.top = `${offsetTop - (count ? 65 : 40)}px`
          tooltip.style.left = `${offsetLeft - 55}px`

          tooltip.innerHTML = `<div>${date}${count ?`<br>коммитов: ${count}` : ''}</div>`
        }

        tooltip.classList.toggle('hidden', ! show)
      }

      const showTooltip = event => {
        const target = event.target
        if (target.classList.contains('day')) {
          if (top !== target.offsetTop || left !== target.offsetLeft)
          {
            top = target.offsetTop
            left = target.offsetLeft
            toggleTooltip(target)
          }
        }
      }

      const hideTooltip = event => {
        top = 0
        left = 0
        toggleTooltip()
      }

      yearGrid.addEventListener('mousemove', showTooltip)
      yearGrid.addEventListener('mouseleave', hideTooltip)
    }

    const parentContainer = document.querySelector('#repoGridContainer')
    const description = parentContainer.querySelector('.description')

    showLoading(true, description)

    fetchCommitStat().then(responseData => {
      return parseResponse(responseData)
    }).then(data => {
      const countsInfo = analyzeCommitCounts(data)
      const colors = makeColors(countsInfo)

      renderRepoInfo({repoName: REPO}, description)

      const yearGrid = renderYearGrid(
        {data, countsInfo, colors},
        parentContainer
      )

      bindTooltip(yearGrid, parentContainer)
    }).catch(error => {
      showError(error, description)
    }).finally(() => {
      showLoading(false, description)
    })
  </script>
</body>
</html>
