<!DOCTYPE html>
<html lang="ru">
<head>
  <title>Реализация выпадающего меню — Выпадающее меню — Дока</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: 50px;
      background-color: #18191c;
      color: #ffffff;
      text-align: center;
      font-family: "Roboto", sans-serif;
    }

    ul, li {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: start;
    }

    button:focus-visible,
    a:focus-visible {
      outline: 2px solid;
      outline-offset: 2px;
    }

    /*
      Почему-то hidden атрибут не работает когда на меню установлен dislay: flex
      Такое решение не самое лучшее, но как быстрый фикс думаю подходит
    */
    .menu[hidden] {
      display: none !important;
    }

    .header {
      display: flex;
      gap: 2rem;
      align-items: center;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0 0 0 / 0.1);
      padding: 1em;
    }

    .menu {
      display: flex;
      gap: 64px;
      min-width: max-content;
      background: #fff;
	    color: #111;
    }

    .menu__btn,
    .menu__link {
      display: flex;
      gap: .5em;
      align-items: center;
      padding: .75rem 1.5rem;
      font-size: 1.5em;
      color: #18191c;
      cursor: pointer;
      border: none;
      background: none;
    }

    .menu__link:hover,
    .menu__btn:hover,
    .menu__btn[aria-expanded="true"] {
      background-color: #eee;
    }

    .menu__btn-icon {
      color: inherit;
	    transition: transform .1s linear;
    }

    .menu__btn[aria-expanded="true"] .menu__btn-icon {
      transform: rotate(180deg);
    }

    .menu__item {
      position: relative;
    }

    .menu__link {
      text-decoration: none;
    }

    a[aria-current="page"] {
      font-weight: bold;
      color: deepPink;
    }

    a[aria-current="page"]:hover {
      color: deepPink;
    }

    /* Вложенное меню */
    .menu .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-inline-start: 3rem;
    }

    /* Первый уровень вложенности */
    .enhanced .menu .menu {
      position: absolute;
      top: 110%;
      left: 0;
      padding-inline-start: 0;
      box-shadow: 0 0 5px 2px rgba(0,0,0,0.1);
    }

    /* Второй уровень вложенности */
    .enhanced .menu .menu .menu {
      top: 0;
      left: 100%;
    }

    .main {
      display: flex;
      width: 100%;
      padding-block-start: 64px;
    }

    .main a {
      color: #fff;
    }

    @media all and (max-width: 1024px) {
      .site-nav {
        width: 100%;
      }

      .menu {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 16px;
      }

      .menu__btn {
        width: 100%;
        justify-content: space-between;
      }

      /* Первый уровень вложенности */
      .enhanced .menu .menu,
      .enhanced .menu .menu .menu {
        position: relative;
        top: 0;
        left: 0;
        box-shadow: none;
        padding-inline-start: 1em;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <nav class="site-nav" aria-label="Сайт">
      <ul class="menu">
        <li class="menu__item" data-has-children>
          <span data-controls="doka-submenu">Дока</span>

          <ul class="menu" id="doka-submenu">
            <li class="menu__item">
              <a href="#" class="menu__link" aria-current="page">Рецепты</a>
            </li>
            <li class="menu__item" data-has-children>
              <span data-controls="html-submenu">HTML</span>

              <ul class="menu" id="html-submenu">
                <li class="menu__item">
                  <a href="#" class="menu__link">Основы</a>
                </li>
                <li class="menu__item">
                  <a href="#" class="menu__link">Форматирование</a>
                </li>
                <li class="menu__item">
                  <a href="#" class="menu__link">Семантика</a>
                </li>
              </ul>
            </li>
            <li class="menu__item" data-has-children>
              <span data-controls="css-submenu">CSS</span>

              <ul class="menu" id="css-submenu">
                <li class="menu__item">
                  <a href="#" class="menu__link">Основы</a>
                </li>
                <li class="menu__item">
                  <a href="#" class="menu__link">Селекторы</a>
                </li>
                <li class="menu__item">
                  <a href="#" class="menu__link">Псевдоклассы</a>
                </li>
              </ul>
            </li>
            <li class="menu__item">
              <a href="#" class="menu__link">JavaScript</a>
            </li>
            <li class="menu__item">
              <a href="#" class="menu__link">Доступность</a>
            </li>
          </ul>
        </li>

        <li class="menu__item">
          <a href="#" class="menu__link">Новости</a>
        </li>
        <li class="menu__item">
          <a href="#" class="menu__link">Блог</a>
        </li>
        <li class="menu__item">
          <a href="#" class="menu__link">Архив</a>
        </li>
      </ul>
    </nav>
  </header>

  <main class="main">
    <a href="#">Тестовая ссылка</a>
  </main>

  <script>
    // Следуем принципам прогрессивного улучшения.
    // Показываем пользователю простую навигацию в случае, если не удаётся загрузить JavaScript.
    // Если JavaScript-файл загружен, заменяем span на кнопки и вешаем дополнительные ARIA-атрибуты.

    const nav = document.querySelector('.site-nav')
    nav.classList.add("enhanced")

    const submenus = document.querySelectorAll(".menu__item[data-has-children]")
    const dropdowns = document.querySelectorAll(".menu__item[data-has-children] > .menu")

    const icon = `
      <svg
        width="24px"
        height="24px"
        viewBox="0 0 24 24"
        aria-hidden="true"
        class="menu__btn-icon"
      >
        <path fill="currentColor" d="M5.293 9.707l6 6c0.391 0.391 1.024 0.391 1.414 0l6-6c0.391-0.391 0.391-1.024 0-1.414s-1.024-0.391-1.414 0l-5.293 5.293-5.293-5.293c-0.391-0.391-1.024-0.391-1.414 0s-0.391 1.024 0 1.414z"></path>
      </svg>
    `

    // Находим подменю, заменяем в нём span на кнопку
    submenus.forEach((item) => {
      const dropdown = item.querySelector(":scope > .menu")
      dropdown.setAttribute("hidden", "")

      const span = item.querySelector(":scope > span")
      const text = span.innerText
      const ariaControlsId = span.dataset.controls

      const button = document.createElement("button")

      // Добавляем класс и необходимые ARIA-атрибуты
      button.classList.add("menu__btn")
      button.setAttribute("aria-expanded", "false")
      button.setAttribute("aria-controls", ariaControlsId)

      button.innerText = text

      // Добавляем иконку к кнопке, чтобы визуально было понятно открыто меню или нет
      button.innerHTML += icon

      span.replaceWith(button)

      button.addEventListener("click", function (e) {
        toggleDropdown(button, dropdown)
      })

      // Обрабатываем нажатие на Esc
      dropdown.addEventListener("keydown", (e) => {
        e.stopImmediatePropagation()

        if (e.keyCode === 27 && focusIsInside(dropdown)) {
          toggleDropdown(button, dropdown)
          button.focus()
        }
      }, false)
    })

    function toggleDropdown(button, dropdown) {
      if (button.getAttribute("aria-expanded") === "true") {
        button.setAttribute("aria-expanded", "false")
        dropdown.setAttribute("hidden", "")
      } else {
        button.setAttribute("aria-expanded", "true")
        dropdown.removeAttribute("hidden")
      }
    }

    function focusIsInside(element) {
      return element.contains(document.activeElement)
    }

    function collapseDropdownsWhenTabbingOutsideNav(e) {
      if (e.keyCode === 9 && !focusIsInside(nav)) {
        dropdowns.forEach(function (dropdown) {
          dropdown.setAttribute("hidden", "")
          const btn = dropdown.parentNode.querySelector("button")
          btn.setAttribute("aria-expanded", "false")
        })
      }
    }

    function collapseDropdownsWhenClickingOutsideNav(e) {
      const target = e.target

      dropdowns.forEach(function (dropdown) {
        if (!dropdown.parentNode.contains(target)) {
          dropdown.setAttribute("hidden", "")
          const btn = dropdown.parentNode.querySelector("button")
          btn.setAttribute("aria-expanded", "false")
        }
      })
    }

    // Закрываем навигацию, если протапались за её пределы
    document.addEventListener("keyup", collapseDropdownsWhenTabbingOutsideNav)

    // Закрываем навигацию, если кликнули вне навигации
    window.addEventListener("click", collapseDropdownsWhenClickingOutsideNav)
  </script>
</body>
</html>
