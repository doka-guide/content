<h2>Кратко</h2>
<p>При копировании объектов или массивов JavaScript копирует данные только на один уровень вглубь. Этот тип копирования называется <em>поверхностным</em> (shallow).</p>
<p>Если необходимо полностью скопировать сложную структуру данных, например, массив с объектами, то нужно делать <em>глубокое</em> (deep) или полное копирование данных. JavaScript не содержит функций для глубокого копирования, лучший вариант сделать глубокую копию — сериализовать структуру в JSON и тут же распарсить.</p>
<h2>Как понять</h2>
<h3>Проблема поверхностного копирования</h3>
<p>Поверхностное копирование работает быстро и в большинстве случаев его достаточно. Проблемы появляются, когда приходится копировать вложенные структуры:</p>
<pre><code class="language-js">const itemsInCart = [
  { product: 'Носки', quantity: 3 },
  { product: 'Штаны', quantity: 1 },
  { product: 'Кепка', quantity: 1 },
]

const clonedCart = [...itemsInCart]
</code></pre>
<p>Если изменять элементы этой структуры после копирования, то эти изменения будут также видны в исходной структуре:</p>
<pre><code class="language-js">clonedCart[1].quantity = 5

console.log(clonedCart)
// [
//    { product: 'Носки', quantity: 3 },
//    { product: 'Штаны', quantity: 5 },
//    { product: 'Кепка', quantity: 1 },
// ]

console.log(itemsInCart)
// [
//    { product: 'Носки', quantity: 3 },
//    { product: 'Штаны', quantity: 5 },
//    { product: 'Кепка', quantity: 1 },
// ]
</code></pre>
<p>Непримитивные типы данных, такие как массивы и объекты, хранятся <a href="/js/ref-type-vs-value-type/#ssylochnye-tipy-dannyh">по ссылке</a>. Так как копирование происходит только на один уровень вглубь, то при копировании массива происходит копирование <em>ссылок на старые объекты</em> в новый массив.</p>
<p>В итоге получается картина, когда разные массивы ссылаются на одни и те же объекты в памяти:</p>
<pre><code class="language-js">console.log(itemsInCart[1] === clonedCart[1])
// true
</code></pre>
<p><img src="images/shallow.png" alt="Результат поверхностного копирования массива"></p>
<h3>Как получить глубокую копию</h3>
<p>JavaScript не содержит отдельных функций для глубокого копирования массивов или объектов. Существуют различные способы сделать глубокое копирование.</p>
<p>Можно написать функцию глубокого копирования вручную. Скорее всего ваша функция будет <a href="/js/recursion/">рекурсивной</a>, и она будет работать только для конкретных данных — написать универсальную функцию не так-то просто.</p>
<p>Можно воспользоваться готовой библиотекой. Например, функцию глубокого копирования содержит популярная библиотека утилит <a href="https://lodash.com/docs/4.17.15#cloneDeep"><em>lodash</em></a>. Функция гарантировано работает в подавляющем большинстве случаев, потому что используется в десятках тысяч проектов каждый день. Исходный код библиотеки открыт, можно изучить <a href="https://github.com/lodash/lodash/blob/4.17.15/lodash.js#L2620">исходный код функции глубокого копирования</a>.</p>
<pre><code class="language-js">import cloneDeep from 'lodash.clonedeep'

const deep = cloneDeep(itemsInCart)
console.log(itemsInCart[1] === deep[1])
// false
</code></pre>
<p>Самый быстрый способ глубокого копирования звучит глупо — нужно сериализовать копируемый объект в <a href="/tools/json/">JSON</a> и тут же распарсить его. В результате появится полная копия объекта:</p>
<pre><code class="language-js">const deep = JSON.parse(JSON.stringify(itemsInCart))
console.log(itemsInCart[1] === deep[1])
// false
</code></pre>
<p><img src="images/deep.png" alt="Результат глубокого копирования массива"></p>
<p>У этого метода есть ограничение — копируемые данные должны быть сериализуемыми. Если объект содержит методы или массив содержит функции, то копирование с помощью JSON-преобразования не сработает:</p>
<pre><code class="language-js">const fns = [
  function() { console.log('aaa') },
  function() { console.log('bbb') },
]
const copyFns = JSON.parse(JSON.stringify(fns))

console.log(copyFns)
// [null, null]
</code></pre>
