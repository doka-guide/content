<h3>Отмена запроса</h3>
<p>Иногда может возникнуть необходимость прервать запрос, например когда авторизация пользователя просрочена или пользователь самостоятельно хочет отменить запрос (отменил скачивание файла).</p>
<pre><code class="language-js">const controller = new AbortController()

function fetchData() {
  return fetch(&quot;http://jsonplaceholder.typicode.com/posts&quot;, {
    signal: controller.signal,
  })
    .then((response) =&gt; response.json())
    .catch((e) =&gt; {
      console.log(e)
    })
}

fetchData()

// Если запрос еще не выполнился, то он будет прерван
// прерванный fetch вернет Promise с ошибкой
controller.abort()
</code></pre>
<p>Запрос не выполнится, в консоли будет ошибка <code>The user aborted a request</code>. Если заглянуть в инструменты разработчика, то там можно увидеть отменённый статус у запроса.</p>
<p><img src="../images/cancelled.png" alt="пример прерванного запроса"></p>
<h3>Загрузка файла на сервер</h3>
<p>С помощью <code>fetch</code> можно загружать файлы на сервер, например когда пользователь хочет загрузить свой аватар в профиль. Отправку файлов можно осуществлять с помощью специального объекта <code>FormData</code>. Покажем на примере обработчика отправки формы.</p>
<pre><code class="language-html">&lt;form id=&quot;form&quot;&gt;
  &lt;input type=&quot;file&quot; id=&quot;avatar&quot;&gt;
  &lt;button type=&quot;submit&quot;&gt;Загрузить&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<pre><code class="language-js">// Находим элемент с файлом
const fileInput = document.getElementById(&quot;avatar&quot;)
const form = document.getElementById(&quot;form&quot;)

function handleSubmit(event) {
  event.preventDefault()

  const formData = new FormData()

  // Добавляем файлы из инпута к данным
  for (let i = 0; i &lt; fileInput.files.length; i++) {
    const file = fileInput.files[i]
    formData.append(&quot;avatar&quot;, file, file.name)
  }

  // Отправляем файлы на сервер
  fetch(&quot;https://backend.com/api/upload&quot;, {
    method: &quot;POST&quot;,
    body: formData,
  })
}

form.addEventListener(&quot;submit&quot;, handleSubmit)
</code></pre>
<h3>Скачивание данных с результатом прогресса</h3>
<p>Чтобы получать текущий прогресс скачивания файла или любых других данных нам понадобится использовать свойство <code>body</code> объекта <code>Response</code>, который возвращается в <code>Promise</code> после вызова <code>fetch</code>. Поле <code>body</code> является «потоком для чтения» (<code>Readable Stream</code>) — это специальный объект, который даёт возможность получать информацию по частям, по мере её поступления на клиент.</p>
<p>Попробуем таким образом загрузить милое видео как белый котик дружит с огромным псом.</p>
<pre><code class="language-js">fetch(&quot;https://i.imgur.com/C5QXZ7u.mp4&quot;).then(async (response) =&gt; {
  let received = 0

  // Получаем поток в переменную
  const reader = response.body.getReader()

  // Считываем общую длину данных
  const contentLength = parseInt(response.headers.get(&quot;Content-Length&quot;), 10)

  while (true) {
    // После вызова read() возвращается объект, в котором
    // done — boolean-значение о том закончилась ли информация
    // value — массив байт, которые пришли в этот раз
    const { done, value } = await reader.read()

    if (done) {
      console.log(`Получено 100%`)
      break
    }

    received += Math.ceil(contentLength / value.length)

    console.log(`Получено ${received}%`)
  }
})
</code></pre>
